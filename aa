<?php
session_start();

// ‚úÖ Restrict to Barangay Officials
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'Barangay Official') {
    header("Location: login.php");
    exit();
}

include 'db_connect.php';
date_default_timezone_set('Asia/Manila');

// ‚úÖ Insert new sensor data (from Arduino GET)
if (isset($_GET['water']) && isset($_GET['rain'])) {
    $waterLevel = floatval($_GET['water']);
    $rainIntensity = floatval($_GET['rain']);
    $currentDateTime = date("Y-m-d H:i:s");

    $stmt = $conn->prepare("INSERT INTO sensor_data (datetime, water, rain) VALUES (?, ?, ?)");
    $stmt->bind_param("sdd", $currentDateTime, $waterLevel, $rainIntensity);
    $stmt->execute();
}

// ‚úÖ Fetch all sensor records
$result = $conn->query("SELECT * FROM sensor_data ORDER BY datetime DESC");

// ‚úÖ Stats for top cards
$totalRecords = $conn->query("SELECT COUNT(*) as total FROM sensor_data")->fetch_assoc()['total'];
$latest = $conn->query("SELECT * FROM sensor_data ORDER BY datetime DESC LIMIT 1")->fetch_assoc();
$latestWater = $latest ? $latest['water'] : 'N/A';
$latestRain  = $latest ? $latest['rain'] : 'N/A';
$latestTime  = $latest ? date("M d, Y h:i A", strtotime($latest['datetime'])) : 'N/A';

// ‚úÖ 30-Day Analytics
$data = $conn->query("
    SELECT DATE(datetime) as day, 
           AVG(rain) as avg_rain, 
           AVG(water) as avg_water
    FROM sensor_data
    GROUP BY day
    ORDER BY day ASC
    LIMIT 30
");

$labels = [];
$rain   = [];
$water  = [];

while ($row = $data->fetch_assoc()) {
    $labels[] = $row['day'];
    $rain[]   = round($row['avg_rain'], 2);
    $water[]  = round($row['avg_water'], 2);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BahaShield - Sensor Data & Analytics</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif;}
    body{background-color:#f4f6f9;min-height:100vh;}
    header{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#1e3a8a,#2563eb);color:#fff;padding:15px 20px;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
    .header-left{display:flex;align-items:center;}
    .menu-icon{font-size:24px;margin-right:15px;cursor:pointer;}
    .system-title{font-size:22px;font-weight:600;}
    .admin-name{margin-left:10px;font-size:14px;opacity:0.9;background:rgba(255,255,255,0.15);padding:5px 12px;border-radius:20px;}

    #sidebar{height:100%;width:0;position:fixed;z-index:1000;top:0;left:0;background-color:#1e3a8a;overflow-x:hidden;transition:0.3s;padding-top:60px;box-shadow:2px 0 6px rgba(0,0,0,0.2);}
    #sidebar a{padding:12px 24px;text-decoration:none;font-size:15px;color:#f1f1f1;display:block;transition:0.2s;}
    #sidebar a:hover,#sidebar a.active{background-color:#2563eb;}
    #sidebar .closebtn{position:absolute;top:10px;right:15px;font-size:26px;color:#fff;}
    .logout-form{text-align:center;margin-top:30px;}
    .logout-btn{background-color:#ef4444;border:none;color:#fff;padding:10px 20px;border-radius:25px;cursor:pointer;font-size:14px;}
    .logout-btn:hover{background-color:#dc2626;}

    main{padding:25px;max-width:1200px;margin:0 auto;}
    main h2{font-size:22px;margin-bottom:20px;color:#1e3a8a;}
    .stat-boxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;}
    .stat-box{background:#fff;padding:15px;border-radius:10px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .stat-box p{font-size:13px;color:#666;}
    .stat-box h3{font-size:20px;margin-top:5px;}

    .controls{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:15px;}
    .search-bar input{padding:8px 12px;border:1px solid #ccc;border-radius:8px;width:250px;font-size:14px;outline:none;}
    .search-bar input:focus{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,0.3);}
    .btn.export{background-color:#2563eb;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;}
    .btn.export:hover{background-color:#1e40af;}

    .table-container{overflow-x:auto;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    #sensorTable{width:100%;border-collapse:collapse;}
    #sensorTable th,#sensorTable td{padding:12px 15px;text-align:left;font-size:14px;}
    #sensorTable th{background-color:#f1f5f9;color:#1e3a8a;text-transform:uppercase;font-size:13px;}
    #sensorTable tr:nth-child(even){background-color:#f9fafb;}
    #sensorTable tr:hover{background-color:#e0ecff;}

    .content-card{background:#fff;padding:15px;border-radius:10px;margin-top:25px;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
    .chart-box{width:100%;overflow-x:auto;}
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>
    <h1 class="system-title">üåä BahaShield</h1>
  </div>
  <span class="admin-name">Welcome, <?php echo htmlspecialchars($_SESSION['fullname']); ?></span>
</header>

<!-- ‚úÖ Sidebar -->
<div id="sidebar">
  <a href="javascript:void(0)" class="closebtn" onclick="toggleMenu()">√ó</a> <br>
  <a href="admin-dashboard.php">üë§ User Management</a>
  <a href="flood_history.php">üìä Flood & Rainfall History</a>
  <a href="sensor_data.php" class="active">üì° Sensor Data & Analytics</a>
  <a href="send_message.php">üí¨ Send SMS</a>
  <form method="POST" action="logout.php" class="logout-form" onsubmit="return confirmLogout();">
    <button type="submit" class="logout-btn">üö™ Logout</button>
  </form>
</div>

<main>
  <h2>üì° Sensor Data Monitoring</h2>

  <!-- ‚úÖ Stats -->
  <div class="stat-boxes">
    <div class="stat-box">üßÆ <p>Total Records</p><h3><?php echo $totalRecords; ?></h3></div>
    <div class="stat-box">üåä <p>Latest Water Level</p><h3><?php echo htmlspecialchars($latestWater); ?> cm</h3></div>
    <div class="stat-box">üåßÔ∏è <p>Latest Rainfall</p><h3><?php echo htmlspecialchars($latestRain); ?></h3></div>
    <div class="stat-box">‚è∞ <p>Last Update</p><h3><?php echo $latestTime; ?></h3></div>
  </div>

  <!-- ‚úÖ Table Controls -->
  <div class="controls">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="üîç Search records...">
    </div>
    <button class="btn export" onclick="exportTableToCSV()">üìÑ Export CSV</button>
  </div>

  <!-- ‚úÖ Sensor Data Table -->
  <div class="table-container">
    <table id="sensorTable">
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Water Level (cm)</th>
          <th>Rain Intensity</th>
        </tr>
      </thead>
      <tbody>
        <?php while ($row = $result->fetch_assoc()) { ?>
          <tr>
            <td><?php echo date("M d, Y h:i A", strtotime($row['datetime'])); ?></td>
            <td><?php echo htmlspecialchars($row['water']); ?></td>
            <td><?php echo htmlspecialchars($row['rain']); ?></td>
          </tr>
        <?php } ?>
      </tbody>
    </table>
  </div>

  <!-- ‚úÖ Analytics Chart -->
  <div class="content-card">
    <h3>üìà Rainfall & Water Level Trends (Last 30 Days)</h3>
    <div class="chart-box">
      <canvas id="trendChart"></canvas>
    </div>
  </div>
</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function toggleMenu() {
  let sidebar = document.getElementById("sidebar");
  sidebar.style.width = (sidebar.style.width === "250px") ? "0" : "250px";
}
window.addEventListener("click", function(e){
  let sidebar=document.getElementById("sidebar");
  if(!e.target.closest('#sidebar') && !e.target.closest('.menu-icon')) sidebar.style.width="0";
});
function confirmLogout(){return confirm("‚ö†Ô∏è Are you sure you want to logout?");}

// üîç Search
document.getElementById("searchInput").addEventListener("keyup",function(){
  let value=this.value.toLowerCase();
  document.querySelectorAll("#sensorTable tbody tr").forEach(row=>{
    row.style.display=row.innerText.toLowerCase().includes(value)?"":"none";
  });
});

// üìÑ Export CSV
function exportTableToCSV(){
  let csv=[];let rows=document.querySelectorAll("#sensorTable tr");
  for(let i=0;i<rows.length;i++){
    let row=[],cols=rows[i].querySelectorAll("td, th");
    for(let j=0;j<cols.length;j++){row.push('"' + cols[j].innerText.replace(/"/g,'""') + '"');}
    csv.push(row.join(","));
  }
  let csvFile=new Blob([csv.join("\n")],{type:"text/csv"});
  let downloadLink=document.createElement("a");
  downloadLink.download="sensor_data.csv";
  downloadLink.href=window.URL.createObjectURL(csvFile);
  downloadLink.style.display="none";
  document.body.appendChild(downloadLink);
  downloadLink.click();
}

// üìà Chart.js
new Chart(document.getElementById('trendChart'), {
  type: 'line',
  data: {
    labels: <?= json_encode($labels) ?>,
    datasets: [{
      label: 'Rainfall (mm)',
      data: <?= json_encode($rain) ?>,
      borderColor: '#3b82f6',
      backgroundColor: 'rgba(59, 130, 246, 0.2)',
      tension: 0.3
    },{
      label: 'Water Level (cm)',
      data: <?= json_encode($water) ?>,
      borderColor: '#ef4444',
      backgroundColor: 'rgba(239, 68, 68, 0.2)',
      tension: 0.3
    }]
  },
  options: {responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
});
</script>
</body>
</html>
